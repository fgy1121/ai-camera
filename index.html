<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI å¥³å‹æ‹ç…§åŠ©æ‰‹</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
}

video {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
}

canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
}

#guideBox {
  position: fixed;
  top: 50%;
  left: 50%;
  width: 60vw;
  height: 70vh;
  transform: translate(-50%, -50%);
  border: 4px solid red;
  border-radius: 20px;
  pointer-events: none;
}

#tipText {
  position: fixed;
  bottom: 80px;
  width: 100%;
  text-align: center;
  font-size: 22px;
  color: white;
  font-weight: bold;
}

#countdown {
  position: fixed;
  top: 40%;
  width: 100%;
  text-align: center;
  font-size: 80px;
  color: yellow;
  font-weight: bold;
}
</style>
</head>

<body>

<video class="input_video" autoplay playsinline muted></video>
<canvas class="output_canvas"></canvas>
<div id="guideBox"></div>
<div id="tipText">æ­£åœ¨è¯†åˆ«...</div>
<div id="countdown"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
const video = document.querySelector(".input_video");
const canvas = document.querySelector(".output_canvas");
const ctx = canvas.getContext("2d");

let isCountingDown = false;

const pose = new Pose({
  locateFile: (file) => {
    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
  }
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  enableSegmentation: false,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

pose.onResults(onResults);

function onResults(results) {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.save();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  if (results.poseLandmarks) {
    const nose = results.poseLandmarks[0];
    const x = nose.x;
    const y = nose.y;

    const guideBox = document.getElementById("guideBox");
    const tipText = document.getElementById("tipText");
    const countdownEl = document.getElementById("countdown");

    let score = 100;
    let tip = "å®Œç¾ï¼Œå¯ä»¥æ‹ï¼";

    if (x < 0.4) {
      tip = "å¾€å³ä¸€ç‚¹ ğŸ‘‰";
      score -= 30;
    } else if (x > 0.6) {
      tip = "å¾€å·¦ä¸€ç‚¹ ğŸ‘ˆ";
      score -= 30;
    }

    if (y < 0.3) {
      tip = "æ‰‹æœºä½ä¸€ç‚¹ ğŸ“±â¬‡ï¸";
      score -= 30;
    } else if (y > 0.7) {
      tip = "äººå¾€å‰ä¸€ç‚¹ ğŸ™†";
      score -= 30;
    }

    if (score >= 80) {
      guideBox.style.borderColor = "lime";
    } else {
      guideBox.style.borderColor = "red";
    }

    tipText.innerText = tip + " è¯„åˆ†ï¼š" + score;

    if (score >= 90 && !isCountingDown) {
      isCountingDown = true;
      let count = 3;
      countdownEl.innerText = count;

      const timer = setInterval(() => {
        count--;
        if (count > 0) {
          countdownEl.innerText = count;
        } else {
          clearInterval(timer);
          countdownEl.innerText = "";
          takePhoto();
          isCountingDown = false;
        }
      }, 1000);
    }
  }

  ctx.restore();
}

const camera = new Camera(video, {
  onFrame: async () => {
    await pose.send({ image: video });
  },
  width: 640,
  height: 480
});

camera.start();

function takePhoto() {
  const link = document.createElement("a");
  link.download = "ai-photo.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}
</script>

</body>
</html>
