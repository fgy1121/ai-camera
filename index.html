<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Â•≥ÂèãÊãçÁÖßÂä©Êâã 3.0</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

video {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
}

canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
}

#guideBox {
  position: fixed;
  top: 50%;
  left: 50%;
  width: 60vw;
  height: 70vh;
  transform: translate(-50%, -50%);
  border: 4px solid red;
  border-radius: 20px;
  pointer-events: none;
  transition: border-color 0.2s ease;
}

#tipText {
  position: fixed;
  bottom: 80px;
  width: 100%;
  text-align: center;
  font-size: 20px;
  color: white;
  font-weight: bold;
  padding: 0 20px;
}

#countdown {
  position: fixed;
  top: 40%;
  width: 100%;
  text-align: center;
  font-size: 80px;
  color: yellow;
  font-weight: bold;
}

#scoreBar {
  position: fixed;
  bottom: 40px;
  left: 10%;
  width: 80%;
  height: 8px;
  background: rgba(255,255,255,0.2);
  border-radius: 10px;
  overflow: hidden;
}

#scoreFill {
  height: 100%;
  width: 0%;
  background: lime;
  transition: width 0.2s ease;
}
</style>
</head>

<body>

<video class="input_video" autoplay playsinline muted></video>
<canvas class="output_canvas"></canvas>

<div id="guideBox"></div>
<div id="tipText">Ê≠£Âú®ËØÜÂà´...</div>
<div id="countdown"></div>

<div id="scoreBar">
  <div id="scoreFill"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.querySelector(".input_video");
const canvas = document.querySelector(".output_canvas");
const ctx = canvas.getContext("2d");

let isCountingDown = false;
let lastPhotoTime = 0;
const cooldown = 8000; // 8ÁßíÂÜ∑Âç¥

const pose = new Pose({
  locateFile: (file) => {
    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
  }
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  enableSegmentation: false,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

pose.onResults(onResults);

function onResults(results) {

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  if (!results.poseLandmarks) return;

  const landmarks = results.poseLandmarks;

  const nose = landmarks[0];
  const leftShoulder = landmarks[11];
  const rightShoulder = landmarks[12];
  const leftAnkle = landmarks[27];
  const rightAnkle = landmarks[28];

  const guideBox = document.getElementById("guideBox");
  const tipText = document.getElementById("tipText");
  const countdownEl = document.getElementById("countdown");
  const scoreFill = document.getElementById("scoreFill");

  let score = 100;
  let tips = [];

  // ===== Â±Ö‰∏≠Âà§Êñ≠ =====
  if (nose.x < 0.35) {
    tips.push("ÂæÄÂè≥‰∏ÄÁÇπ üëâ");
    score -= 20;
  } else if (nose.x > 0.65) {
    tips.push("ÂæÄÂ∑¶‰∏ÄÁÇπ üëà");
    score -= 20;
  }

  // ===== Â§¥È°∂ÂÆâÂÖ®Ë∑ùÁ¶ª =====
  if (nose.y < 0.15) {
    tips.push("Â§¥È°∂Â§™Ë¥¥Ëæπ üìè");
    score -= 25;
  }

  // ===== ËÑöÊòØÂê¶Ë¢´Ë£Å =====
  if (leftAnkle.y > 0.95 || rightAnkle.y > 0.95) {
    tips.push("ËÑöË¢´Ë£Å‰∫Ü üì∏‚¨áÔ∏è");
    score -= 25;
  }

  // ===== Ë∫´‰ΩìÊòØÂê¶Ê≠™ =====
  const shoulderDiff = Math.abs(leftShoulder.y - rightShoulder.y);
  if (shoulderDiff > 0.05) {
    tips.push("Ë∫´‰ΩìÊúâÁÇπÊ≠™ ü§è");
    score -= 15;
  }

  // ===== ÈªÑÈáëÂàÜÂâ≤‰ºòÂåñ =====
  if (nose.x > 0.38 && nose.x < 0.62) {
    score += 10;
  }

  if (score > 100) score = 100;
  if (score < 0) score = 0;

  scoreFill.style.width = score + "%";

  if (score >= 85) {
    guideBox.style.borderColor = "lime";
  } else {
    guideBox.style.borderColor = "red";
  }

  if (tips.length === 0) {
    tipText.innerText = "ÊûÑÂõæÂæàÂ•ΩÔºåÂèØ‰ª•ÊãçÔºÅ ËØÑÂàÜÔºö" + score;
  } else {
    tipText.innerText = tips.join(" | ") + " ËØÑÂàÜÔºö" + score;
  }

  // ===== Ëá™Âä®ÊãçÁÖß + ÂÜ∑Âç¥Êú∫Âà∂ =====
  const now = Date.now();
  if (score >= 90 && !isCountingDown && now - lastPhotoTime > cooldown) {
    isCountingDown = true;
    let count = 3;
    countdownEl.innerText = count;

    const timer = setInterval(() => {
      count--;
      if (count > 0) {
        countdownEl.innerText = count;
      } else {
        clearInterval(timer);
        countdownEl.innerText = "";
        takePhoto();
        lastPhotoTime = Date.now();
        isCountingDown = false;
      }
    }, 1000);
  }
}

const camera = new Camera(video, {
  onFrame: async () => {
    await pose.send({ image: video });
  },
  width: 640,
  height: 480
});

camera.start();

function takePhoto() {
  const link = document.createElement("a");
  link.download = "ai-photo.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}
</script>

</body>
</html>
