<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI 摄影导航系统 2.0</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:black;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
}

video,canvas{
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  object-fit:cover;
}

#overlay{
  position:fixed;
  width:100vw;
  height:100vh;
  pointer-events:none;
}

#targetDot{
  position:absolute;
  width:18px;
  height:18px;
  border-radius:50%;
  background:white;
  transform:translate(-50%,-50%);
  transition:all 0.2s ease;
}

#moveCircle{
  position:absolute;
  border:3px solid red;
  border-radius:50%;
  transform:translate(-50%,-50%);
  transition:all 0.1s linear;
}

#tip{
  position:fixed;
  bottom:120px;
  width:100%;
  text-align:center;
  color:white;
  font-size:20px;
  font-weight:bold;
}

#ready{
  position:fixed;
  bottom:160px;
  width:100%;
  text-align:center;
  font-size:22px;
  color:lime;
  font-weight:bold;
  display:none;
}

#shutter{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  width:80px;
  height:80px;
  border-radius:50%;
  border:6px solid white;
  background:red;
}

#switchCam{
  position:fixed;
  top:20px;
  right:20px;
  padding:10px 15px;
  background:rgba(0,0,0,0.6);
  color:white;
  border:1px solid white;
  border-radius:8px;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="overlay">
  <div id="targetDot"></div>
  <div id="moveCircle"></div>
</div>

<div id="ready">机位完美 ✔ 现在拍</div>
<div id="tip">正在识别人物...</div>
<button id="shutter"></button>
<button id="switchCam">切换</button>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const targetDot=document.getElementById("targetDot");
const moveCircle=document.getElementById("moveCircle");
const tip=document.getElementById("tip");
const ready=document.getElementById("ready");

let currentFacing="environment";
let currentStream=null;
let detecting=false;
let perfect=false;

let targetX=0.618;
let targetY=0.382;

const pose=new Pose({
  locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({
  modelComplexity:1,
  smoothLandmarks:true,
  minDetectionConfidence:0.6,
  minTrackingConfidence:0.6
});

pose.onResults(results=>{
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(results.image,0,0,canvas.width,canvas.height);

  if(!results.poseLandmarks)return;

  const lm=results.poseLandmarks;

  const centerX=(lm[11].x+lm[12].x)/2;
  const eyeY=(lm[2].y+lm[5].y)/2;

  const shoulderWidth=Math.abs(lm[11].x-lm[12].x);

  const hasAnkle = lm[27].visibility>0.5 || lm[28].visibility>0.5;

  // ===== 动态黄金点 =====
  targetX = centerX < 0.5 ? 0.618 : 0.382;
  targetY = hasAnkle ? 0.5 : 0.382;

  targetDot.style.left=(targetX*100)+"%";
  targetDot.style.top=(targetY*100)+"%";

  const dx=centerX-targetX;
  const dy=eyeY-targetY;
  const distance2D=Math.sqrt(dx*dx+dy*dy);

  let distanceScore = distance2D;

  let messages=[];

  if(dx>0)messages.push("往左移动");
  if(dx<0)messages.push("往右移动");
  if(dy>0)messages.push("手机往上抬");
  if(dy<0)messages.push("手机往下压");

  // ===== 前后距离判断 =====
  if(shoulderWidth<0.15){
    messages.push("往前走");
    distanceScore+=0.05;
  }
  if(shoulderWidth>0.30){
    messages.push("往后退");
    distanceScore+=0.05;
  }

  const size=Math.max(20,distanceScore*800);

  moveCircle.style.width=size+"px";
  moveCircle.style.height=size+"px";
  moveCircle.style.left=(targetX*100)+"%";
  moveCircle.style.top=(targetY*100)+"%";

  if(distanceScore<0.03){
    moveCircle.style.borderColor="lime";
    ready.style.display="block";
    tip.innerText="构图完美";
    perfect=true;
  }else{
    moveCircle.style.borderColor="red";
    ready.style.display="none";
    perfect=false;
    tip.innerText=messages.join("  ");
  }
});

async function detectLoop(){
  if(!detecting) return;
  await pose.send({image:video});
  requestAnimationFrame(detectLoop);
}

async function startCamera(){
  detecting=false;

  if(currentStream){
    currentStream.getTracks().forEach(track=>track.stop());
    currentStream=null;
  }

  const stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:currentFacing}
  });

  currentStream=stream;
  video.srcObject=stream;
  await video.play();

  detecting=true;
  detectLoop();
}

document.getElementById("switchCam").addEventListener("click",()=>{
  detecting=false;
  currentFacing=currentFacing==="environment"?"user":"environment";
  setTimeout(startCamera,200);
});

document.getElementById("shutter").addEventListener("click",()=>{
  if(!perfect){
    alert("机位还没对齐");
    return;
  }
  const link=document.createElement("a");
  link.download="perfect-shot.png";
  link.href=canvas.toDataURL("image/png");
  link.click();
});

startCamera();
</script>

</body>
</html>
