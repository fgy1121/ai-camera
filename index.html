<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI å¥³å‹æ‹ç…§åŠ©æ‰‹ 6.0</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

video, canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
}

#guideBox {
  position: fixed;
  top: 50%;
  left: 50%;
  width: 60vw;
  transform: translate(-50%, -50%);
  border: 4px solid red;
  border-radius: 20px;
  pointer-events: none;
  transition: all 0.3s ease;
}

#modeLabel {
  position: fixed;
  top: 20px;
  width: 100%;
  text-align: center;
  color: white;
  font-size: 18px;
  font-weight: bold;
}

#tipText {
  position: fixed;
  bottom: 120px;
  width: 100%;
  text-align: center;
  font-size: 18px;
  color: white;
  font-weight: bold;
  padding: 0 20px;
}

#scoreText {
  position: fixed;
  bottom: 90px;
  width: 100%;
  text-align: center;
  font-size: 20px;
  color: yellow;
  font-weight: bold;
}

#shutterBtn {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 6px solid white;
  background: red;
  transition: all 0.3s ease;
}

#readyHint {
  position: fixed;
  bottom: 180px;
  width: 100%;
  text-align: center;
  font-size: 22px;
  color: lime;
  font-weight: bold;
  display: none;
}
</style>
</head>

<body>

<video class="input_video" autoplay playsinline muted></video>
<canvas class="output_canvas"></canvas>

<div id="guideBox"></div>
<div id="modeLabel">æ­£åœ¨åˆ†ææ„å›¾...</div>
<div id="tipText">æ­£åœ¨è¯†åˆ«...</div>
<div id="scoreText"></div>
<div id="readyHint">æ„å›¾å¾ˆå¥½ï¼Œå¯ä»¥æ‹äº†ï¼ğŸ“¸</div>

<button id="shutterBtn"></button>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.querySelector(".input_video");
const canvas = document.querySelector(".output_canvas");
const ctx = canvas.getContext("2d");
const shutterBtn = document.getElementById("shutterBtn");

let currentScore = 0;

const pose = new Pose({
  locateFile: (file) => {
    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
  }
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

pose.onResults(onResults);

function onResults(results) {

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  if (!results.poseLandmarks) return;

  const landmarks = results.poseLandmarks;
  const nose = landmarks[0];
  const leftAnkle = landmarks[27];
  const rightAnkle = landmarks[28];

  const guideBox = document.getElementById("guideBox");
  const tipText = document.getElementById("tipText");
  const scoreText = document.getElementById("scoreText");
  const modeLabel = document.getElementById("modeLabel");
  const readyHint = document.getElementById("readyHint");

  let score = 100;
  let tips = [];

  const bodyTop = nose.y;
  const bodyBottom = Math.max(leftAnkle.y, rightAnkle.y);
  const bodyHeight = bodyBottom - bodyTop;

  let recommendedMode = "";

  if (bodyHeight > 0.75) {
    recommendedMode = "åŠèº«æ›´åˆé€‚ ğŸ“·";
    guideBox.style.height = "55vh";
  } 
  else if (bodyHeight > 0.45) {
    recommendedMode = "å…¨èº«æ„å›¾ä¸é”™ ğŸ“¸";
    guideBox.style.height = "75vh";
  } 
  else {
    recommendedMode = "äººç‰©å¤ªå°ï¼Œé è¿‘ä¸€ç‚¹ ğŸ‘£";
    guideBox.style.height = "75vh";
    score -= 30;
  }

  modeLabel.innerText = "AI æ¨èï¼š" + recommendedMode;

  if (nose.x < 0.35) {
    tips.push("å¾€å³ä¸€ç‚¹ ğŸ‘‰");
    score -= 20;
  } else if (nose.x > 0.65) {
    tips.push("å¾€å·¦ä¸€ç‚¹ ğŸ‘ˆ");
    score -= 20;
  }

  if (nose.y < 0.12) {
    tips.push("å¤´é¡¶å¤ªè´´è¾¹ ğŸ“");
    score -= 20;
  }

  if (score > 100) score = 100;
  if (score < 0) score = 0;

  currentScore = score;

  if (score >= 85) {
    guideBox.style.borderColor = "lime";
  } else {
    guideBox.style.borderColor = "red";
  }

  if (tips.length === 0) {
    tipText.innerText = "æ„å›¾ä¸é”™ ğŸ‘";
  } else {
    tipText.innerText = tips.join(" | ");
  }

  scoreText.innerText = "å½“å‰è¯„åˆ†ï¼š" + score;

  if (score >= 90) {
    shutterBtn.style.background = "lime";
    readyHint.style.display = "block";
  } else {
    shutterBtn.style.background = "red";
    readyHint.style.display = "none";
  }
}

const camera = new Camera(video, {
  onFrame: async () => {
    await pose.send({ image: video });
  },
  width: 640,
  height: 480
});

camera.start();

shutterBtn.addEventListener("click", () => {
  if (currentScore < 70) {
    alert("æ„å›¾ä¸€èˆ¬ï¼Œå†è°ƒæ•´ä¸€ä¸‹ä¼šæ›´å¥½ ğŸ‘");
    return;
  }

  const link = document.createElement("a");
  link.download = "ai-photo.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
});
</script>

</body>
</html>
