<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI 摄影导航系统</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:black;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
}

video,canvas{
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  object-fit:cover;
}

#overlay{
  position:fixed;
  width:100vw;
  height:100vh;
  pointer-events:none;
}

#targetDot{
  position:absolute;
  width:18px;
  height:18px;
  border-radius:50%;
  background:white;
  transform:translate(-50%,-50%);
}

#moveCircle{
  position:absolute;
  border:3px solid red;
  border-radius:50%;
  transform:translate(-50%,-50%);
}

#tip{
  position:fixed;
  bottom:120px;
  width:100%;
  text-align:center;
  color:white;
  font-size:20px;
  font-weight:bold;
}

#ready{
  position:fixed;
  bottom:160px;
  width:100%;
  text-align:center;
  font-size:22px;
  color:lime;
  font-weight:bold;
  display:none;
}

#shutter{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  width:80px;
  height:80px;
  border-radius:50%;
  border:6px solid white;
  background:red;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="overlay">
  <div id="targetDot"></div>
  <div id="moveCircle"></div>
</div>

<div id="ready">机位完美 ✔ 现在拍</div>
<div id="tip">正在识别人物...</div>
<button id="shutter"></button>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const targetDot=document.getElementById("targetDot");
const moveCircle=document.getElementById("moveCircle");
const tip=document.getElementById("tip");
const ready=document.getElementById("ready");

let perfect=false;

// ===== 黄金构图点（右上黄金点）=====
let targetX=0.618;
let targetY=0.382;

targetDot.style.left=(targetX*100)+"%";
targetDot.style.top=(targetY*100)+"%";

// ===== 初始化姿态识别 =====
const pose=new Pose({
  locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({
  modelComplexity:1,
  smoothLandmarks:true,
  minDetectionConfidence:0.6,
  minTrackingConfidence:0.6
});

pose.onResults(results=>{
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(results.image,0,0,canvas.width,canvas.height);

  if(!results.poseLandmarks)return;

  const lm=results.poseLandmarks;
  const leftShoulder=lm[11];
  const rightShoulder=lm[12];
  const leftEye=lm[2];
  const rightEye=lm[5];

  const centerX=(leftShoulder.x+rightShoulder.x)/2;
  const eyeY=(leftEye.y+rightEye.y)/2;

  const dx=centerX-targetX;
  const dy=eyeY-targetY;

  const distance=Math.sqrt(dx*dx+dy*dy);

  const size=Math.max(20,distance*800);

  moveCircle.style.width=size+"px";
  moveCircle.style.height=size+"px";
  moveCircle.style.left=(targetX*100)+"%";
  moveCircle.style.top=(targetY*100)+"%";

  if(distance<0.03){
    moveCircle.style.borderColor="lime";
    ready.style.display="block";
    tip.innerText="保持位置，构图完美";
    perfect=true;
  }else{
    moveCircle.style.borderColor="red";
    ready.style.display="none";
    perfect=false;

    let messages=[];
    if(dx>0)messages.push("往左移动");
    if(dx<0)messages.push("往右移动");
    if(dy>0)messages.push("手机往上抬");
    if(dy<0)messages.push("手机往下压");

    tip.innerText=messages.join("  ");
  }
});

// ===== 强制优先后置摄像头 =====
async function startCamera(){

  try{
    await navigator.mediaDevices.getUserMedia({video:true});

    const devices=await navigator.mediaDevices.enumerateDevices();
    const videoDevices=devices.filter(d=>d.kind==="videoinput");

    let backCamera=videoDevices.find(d=>
      d.label.toLowerCase().includes("back") ||
      d.label.toLowerCase().includes("rear") ||
      d.label.toLowerCase().includes("environment")
    );

    if(!backCamera && videoDevices.length>0){
      backCamera=videoDevices[videoDevices.length-1];
    }

    if(!backCamera){
      alert("没有找到摄像头");
      return;
    }

    const stream=await navigator.mediaDevices.getUserMedia({
      video:{
        deviceId:{exact:backCamera.deviceId}
      }
    });

    video.srcObject=stream;
    video.play();

    const camera=new Camera(video,{
      onFrame:async()=>await pose.send({image:video}),
      width:640,
      height:480
    });

    camera.start();

  }catch(err){
    alert("摄像头启动失败: "+err);
  }
}

startCamera();

// ===== 手动拍照 =====
document.getElementById("shutter").addEventListener("click",()=>{
  if(!perfect){
    alert("机位还没对齐");
    return;
  }
  const link=document.createElement("a");
  link.download="perfect-shot.png";
  link.href=canvas.toDataURL("image/png");
  link.click();
});
</script>

</body>
</html>
